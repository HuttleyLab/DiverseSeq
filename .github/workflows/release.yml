name: Release

on: [workflow_dispatch]

jobs:
  build:
    name: Build wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build wheels with cibuildwheel
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_BUILD: "cp311-* cp312-* cp313-* cp314-*"
          CIBW_SKIP: "*-win32 *-i686"
          CIBW_BEFORE_ALL_LINUX: "bash -c 'echo \"=== Container Info ===\"  && echo \"PATH: $PATH\" && which bash && which sh && ls /bin/*apt* 2>/dev/null || echo \"no apt found\" && ls /bin/*yum* 2>/dev/null || echo \"no yum found\" && cat /etc/os-release 2>/dev/null || echo \"no os-release\" && apt-get update && apt-get install -y libatomic1 && curl --proto \"=https\" --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y'"
          CIBW_ENVIRONMENT_LINUX: 'PATH="$HOME/.cargo/bin:$PATH"'

      - name: Build sdist (once on ubuntu 3.13)
        if: matrix.os == 'ubuntu-latest'
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --sdist

      - name: Move wheels to dist for consistent artifact structure
        run: |
          python -c "import glob, os, shutil; os.makedirs('dist', exist_ok=True); [shutil.move(f, os.path.join('dist', os.path.basename(f))) for f in glob.glob('wheelhouse/*.whl')]"

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dvs-dist-${{ matrix.os }}
          path: |
            ./dist/*.whl
            ./dist/*.tar.gz

  test:
    needs: [build]
    name: "Test on Python ${{ matrix.python-version }} (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: "actions/checkout@v6"
        with:
          fetch-depth: 0

      - uses: "actions/setup-python@v6"
        with:
            python-version: "${{ matrix.python-version }}"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: "Installs for ${{ matrix.python-version }}"
        run: |
          uv venv venv -p python${{ matrix.python-version }}
          uv tool install -p venv nox

      - name: Download built artifact for this matrix
        uses: actions/download-artifact@v7
        with:
          name: dvs-dist-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ./dist
          merge-multiple: true

      - name: Detect wheel path
        run: |
          python -c "import glob, os; wheels = glob.glob('dist/**/*.whl', recursive=True); wheel = wheels[0] if wheels else ''; env = os.environ['GITHUB_ENV']; open(env, 'a').write(f'WHEEL_PATH={wheel}\n'); print(f'Detected wheel: {wheel}')"

      - name: "Run nox for Python ${{ matrix.python-version }}"
        run: "nox -db uv --force-python python -s test"

  release_test:
    name: Release to Test PyPI
    needs: [test,build]
    environment: release_test
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - name: Download all built artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./dist
          merge-multiple: true

      - name: Flatten dist contents
        run: |
          python -c "import glob, os, shutil; files = glob.glob('dist/**/*.whl', recursive=True) + glob.glob('dist/**/*.tar.gz', recursive=True); os.makedirs('dist', exist_ok=True); [shutil.move(f, os.path.join('dist', os.path.basename(f))) for f in files if os.path.dirname(f) != 'dist']; print('Flattened files:', [os.path.basename(f) for f in files])"

      - name: Publish package distributions to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
  
  release:
    name: Release to PyPI
    needs: release_test
    environment: release
    runs-on: ubuntu-latest
    permissions:
      id-token: write

    steps:
      - name: Download all built artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./dist
          merge-multiple: true

      - name: Flatten dist contents
        run: |
          python -c "import glob, os, shutil; files = glob.glob('dist/**/*.whl', recursive=True) + glob.glob('dist/**/*.tar.gz', recursive=True); os.makedirs('dist', exist_ok=True); [shutil.move(f, os.path.join('dist', os.path.basename(f))) for f in files if os.path.dirname(f) != 'dist']; print('Flattened files:', [os.path.basename(f) for f in files])"

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
